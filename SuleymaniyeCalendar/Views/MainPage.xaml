<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="SuleymaniyeCalendar.Views.MainPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:localization="clr-namespace:LocalizationResourceManager.Maui;assembly=LocalizationResourceManager.Maui"
    xmlns:models="clr-namespace:SuleymaniyeCalendar.Models"
    xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
    xmlns:viewModels="clr-namespace:SuleymaniyeCalendar.ViewModels"
    x:Name="MainPageRoot"
    Title="{Binding Title}"
    x:DataType="viewModels:MainViewModel"
    FlowDirection="{DynamicResource FlowDirection}">

    <Shell.TitleView>
        <StackLayout
            Margin="10"
            x:DataType="viewModels:MainViewModel"
            HeightRequest="40"
            Orientation="Horizontal">
            <Label
                AutomationProperties.IsInAccessibleTree="True"
                FontAttributes="Bold"
                FontSize="{DynamicResource HeaderFontSize}"
                HorizontalOptions="StartAndExpand"
                SemanticProperties.Description="{localization:Translate Takvim}"
                SemanticProperties.HeadingLevel="Level1"
                Style="{StaticResource LabelSectionHeader}"
                Text="{localization:Translate PageTitle}"
                VerticalTextAlignment="Start" />
            <Image
                Margin="10,0,20,0"
                AutomationProperties.IsInAccessibleTree="True"
                SemanticProperties.Description="{localization:Translate UygulamaAyarlari}">
                <Image.Source>
                    <FontImageSource
                        FontAutoScalingEnabled="True"
                        FontFamily="{StaticResource IconFontFamily}"
                        Glyph="&#xf013;"
                        Size="{DynamicResource IconLargeFontSize}" />
                </Image.Source>
                <Image.GestureRecognizers>
                    <TapGestureRecognizer Command="{Binding SettingsCommand}" NumberOfTapsRequired="1" />
                </Image.GestureRecognizers>
            </Image>
            <Image
                Margin="10,0,20,0"
                AutomationProperties.IsInAccessibleTree="True"
                SemanticProperties.Description="{localization:Translate Yenile}">
                <Image.Source>
                    <FontImageSource
                        FontFamily="{StaticResource IconFontFamily}"
                        Glyph="&#xf2f1;"
                        Size="{DynamicResource IconLargeFontSize}" />
                </Image.Source>
                <Image.GestureRecognizers>
                    <TapGestureRecognizer Command="{Binding RefreshLocationCommand}" NumberOfTapsRequired="1" />
                </Image.GestureRecognizers>
            </Image>
        </StackLayout>
    </Shell.TitleView>

    <ContentPage.Content>
        <RefreshView Command="{Binding RefreshLocationCommand}" IsRefreshing="{Binding IsRefreshing}">
            <Grid
                Padding="4,3"
                ColumnDefinitions="*"
                HorizontalOptions="CenterAndExpand"
                RowDefinitions="*">
                <CollectionView
                    x:Name="PrayersView"
                    HorizontalOptions="Fill"
                    ItemsSource="{Binding Prayers}"
                    SelectedItem="{Binding SelectedPrayer, Mode=TwoWay}"
                    SelectionChangedCommand="{Binding PrayerSelectedCommand}"
                    SelectionMode="Single"
                    VerticalOptions="Fill"
                    VerticalScrollBarVisibility="Never">
                    <CollectionView.ItemsLayout>
                        <LinearItemsLayout ItemSpacing="0" Orientation="Vertical" />
                    </CollectionView.ItemsLayout>
                    <CollectionView.Header>
                        <StackLayout>
                            <Border
                                Margin="3,7"
                                BackgroundColor="{AppThemeBinding Light={StaticResource CityBackgroundColor},
                                                                  Dark={StaticResource CityBackgroundColorDark}}"
                                HorizontalOptions="Center"
                                IsEnabled="{Binding IsNotBusy}"
                                Style="{StaticResource RoundButton}">
                                <Label
                                    Margin="5,0"
                                    Padding="9,3"
                                    x:DataType="viewModels:MainViewModel"
                                    AutomationProperties.IsInAccessibleTree="True"
                                    FontAttributes="Bold"
                                    HorizontalOptions="Center"
                                    SemanticProperties.Description="{localization:Translate Sehir}"
                                    Style="{StaticResource BodyMediumLabel}"
                                    TextColor="{AppThemeBinding Light={StaticResource ButtonTextColor},
                                                                Dark={StaticResource ButtonTextColorDark}}"
                                    VerticalTextAlignment="Center">
                                    <Label.FormattedText>
                                        <FormattedString>
                                            <Span
                                                FontFamily="{StaticResource IconFontFamily}"
                                                FontSize="{DynamicResource SubHeaderFontSize}"
                                                Text="&#xf3c5; " />
                                            <Span Text="{Binding City}" TextTransform="Uppercase" />
                                        </FormattedString>
                                    </Label.FormattedText>
                                </Label>
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding GoToMapCommand}" NumberOfTapsRequired="1" />
                                </Border.GestureRecognizers>
                            </Border>
                        </StackLayout>
                    </CollectionView.Header>

                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="models:Prayer">
                            <ContentView Padding="4,3">
                                <!-- Outer container to allow shadow bleed beyond rounded corners -->
                                <Border
                                    Margin="4"
                                    Padding="4"
                                    Opacity="{Binding Opacity}"
                                    Style="{StaticResource AnimatedPrayerCard}">
                                    <Border.Triggers>
                                        <DataTrigger
                                            Binding="{Binding IsPast}"
                                            TargetType="Border"
                                            Value="True">
                                            <Setter Property="BackgroundColor" Value="{AppThemeBinding Light={StaticResource PastTimeBackgroundColor}, Dark={StaticResource PastTimeBackgroundColorDark}}" />
                                        </DataTrigger>
                                        <DataTrigger
                                            Binding="{Binding IsActive}"
                                            TargetType="Border"
                                            Value="True">
                                            <Setter Property="BackgroundColor" Value="{AppThemeBinding Light={StaticResource CurrentTimeBackgroundColor}, Dark={StaticResource CurrentTimeBackgroundColorDark}}" />
                                        </DataTrigger>
                                        <DataTrigger
                                            Binding="{Binding IsUpcoming}"
                                            TargetType="Border"
                                            Value="True">
                                            <Setter Property="BackgroundColor" Value="{AppThemeBinding Light={StaticResource FutureTimeBackgroundColor}, Dark={StaticResource FutureTimeBackgroundColorDark}}" />
                                        </DataTrigger>
                                    </Border.Triggers>
                                    <Grid
                                        Margin="0"
                                        Padding="12,8"
                                        ColumnDefinitions="*,Auto,Auto"
                                        ColumnSpacing="12">

                                        <!--  Prayer Name  -->
                                        <Label
                                            Grid.Column="0"
                                            Style="{StaticResource BodyLargeLabel}"
                                            Text="{Binding Name}"
                                            TextColor="{AppThemeBinding Light={StaticResource Gray900},
                                                                        Dark={StaticResource White}}"
                                            VerticalOptions="Center" />

                                        <!--  Time Display  -->
                                        <Label
                                            Grid.Column="1"
                                            HorizontalTextAlignment="End"
                                            Style="{StaticResource BodyLargeLabel}"
                                            Text="{Binding Time}"
                                            TextColor="{AppThemeBinding Light={StaticResource PrimaryColor},
                                                                        Dark={StaticResource PrimaryAccent100Color}}"
                                            VerticalOptions="Center" />

                                        <!--  Notification Bell  -->
                                        <Label
                                            Grid.Column="2"
                                            Margin="8,0,0,0"
                                            AutomationProperties.IsInAccessibleTree="True"
                                            FontFamily="FontAwesomeSolid"
                                            FontSize="{DynamicResource HeaderFontSize}"
                                            HorizontalOptions="Center"
                                            Text="&#xe7f6;"
                                            TextColor="{AppThemeBinding Light={StaticResource PrimaryColor},
                                                                        Dark={StaticResource PrimaryAccent50Color}}"
                                            VerticalOptions="Center">
                                            <Label.Triggers>
                                                <DataTrigger
                                                    Binding="{Binding Enabled}"
                                                    TargetType="Label"
                                                    Value="False">
                                                    <Setter Property="Text" Value="&#xf1f6;" />
                                                    <Setter Property="SemanticProperties.Description" Value="{localization:Translate DevreDisi}" />
                                                    <Setter Property="Opacity" Value="0.8" />
                                                </DataTrigger>
                                                <DataTrigger
                                                    Binding="{Binding Enabled}"
                                                    TargetType="Label"
                                                    Value="True">
                                                    <Setter Property="Text" Value="&#xf0f3;" />
                                                    <Setter Property="SemanticProperties.Description" Value="{localization:Translate Etkin}" />
                                                    <Setter Property="Opacity" Value="1.0" />
                                                </DataTrigger>
                                            </Label.Triggers>
                                            <Label.GestureRecognizers>
                                                <TapGestureRecognizer x:DataType="{x:Null}"
                                                    Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.PrayerSelectedCommand}"
                                                    CommandParameter="{Binding .}" />
                                            </Label.GestureRecognizers>
                                        </Label>
                                    </Grid>
                                </Border>
                            </ContentView>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>

                    <CollectionView.Footer>
                        <StackLayout Orientation="Vertical">
                            <Border
                                Margin="3,7"
                                BackgroundColor="{AppThemeBinding Light={StaticResource MonthlyButtonBackgroundColor},
                                                                  Dark={StaticResource MonthlyButtonBackgroundColorDark}}"
                                HorizontalOptions="Center"
                                IsEnabled="{Binding IsNotBusy}"
                                Style="{StaticResource RoundButton}">
                                <Label
                                    Margin="9,0"
                                    Padding="9,3"
                                    x:DataType="viewModels:MainViewModel"
                                    Style="{StaticResource BodyLargeLabel}"
                                    TextColor="{AppThemeBinding Light={StaticResource ButtonTextColor},
                                                                Dark={StaticResource ButtonTextColorDark}}">
                                    <Label.FormattedText>
                                        <FormattedString>
                                            <Span
                                                FontFamily="{StaticResource IconFontFamily}"
                                                FontSize="{DynamicResource SubHeaderFontSize}"
                                                Text="&#xf073; " />
                                            <Span Text="{localization:Translate AylikTakvim}" />
                                        </FormattedString>
                                    </Label.FormattedText>
                                </Label>
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer
                                        x:DataType="viewModels:MainViewModel"
                                        Command="{Binding GoToMonthCommand}"
                                        NumberOfTapsRequired="1" />
                                </Border.GestureRecognizers>
                            </Border>

                            <Border
                                Margin="3"
                                Padding="9"
                                BackgroundColor="{AppThemeBinding Light={StaticResource SurfaceColor},
                                                                  Dark={StaticResource DarkElevation8dp}}"
                                Style="{StaticResource Card}">
                                <Label
                                    AutomationProperties.IsInAccessibleTree="True"
                                    HorizontalOptions="Center"
                                    HorizontalTextAlignment="Center"
                                    Style="{StaticResource BodyLargeLabel}"
                                    Text="{Binding RemainingTime}"
                                    TextColor="{AppThemeBinding Light={StaticResource PrimaryDarkColor},
                                                                Dark={StaticResource White}}"
                                    VerticalTextAlignment="Center" />
                            </Border>
                        </StackLayout>
                    </CollectionView.Footer>
                </CollectionView>
            </Grid>
        </RefreshView>
    </ContentPage.Content>
</ContentPage>
