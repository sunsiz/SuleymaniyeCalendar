<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="SuleymaniyeCalendar.Views.MainPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:localization="clr-namespace:LocalizationResourceManager.Maui;assembly=LocalizationResourceManager.Maui"
    xmlns:models="clr-namespace:SuleymaniyeCalendar.Models"
    xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
    xmlns:viewModels="clr-namespace:SuleymaniyeCalendar.ViewModels"
    xmlns:converters="clr-namespace:SuleymaniyeCalendar.Converters"
    x:Name="MainPageRoot"
    Title="{Binding Title}"
    x:DataType="viewModels:MainViewModel"
    FlowDirection="{DynamicResource FlowDirection}"
    Background="{AppThemeBinding Light={StaticResource Surface}, Dark={StaticResource SurfaceDark}}">

    <ContentPage.Resources>
        <ResourceDictionary>
            <converters:BoolToBellIconConverter x:Key="BoolToBellIconConverter" />
            <converters:BoolToBellColorConverter x:Key="BoolToBellColorConverter" />
        </ResourceDictionary>
    </ContentPage.Resources>

    <ContentPage.ToolbarItems>
        <ToolbarItem IconImageSource="{FontImageSource FontFamily=IconFont, Glyph='&#xf013;', Color={AppThemeBinding Light={StaticResource OnSurfaceLight}, Dark={StaticResource OnSurfaceDark}}}"
                     Command="{Binding SettingsCommand}"
                     Text="{localization:Translate UygulamaAyarlari}" />
        <ToolbarItem IconImageSource="{FontImageSource FontFamily=IconFont, Glyph='&#xf2f1;', Color={AppThemeBinding Light={StaticResource OnSurfaceLight}, Dark={StaticResource OnSurfaceDark}}}"
                     Command="{Binding RefreshLocationCommand}"
                     Text="{localization:Translate Yenile}" />
    </ContentPage.ToolbarItems>

    <ContentPage.Content>
        <RefreshView Command="{Binding RefreshLocationCommand}" IsRefreshing="{Binding IsRefreshing}">
            <Grid ColumnDefinitions="*" RowDefinitions="*" HorizontalOptions="Fill" Margin="0" Padding="0" >
                <CollectionView
                    x:Name="PrayersView"
                    HorizontalOptions="Center"
                    ItemsSource="{Binding Prayers}"
                    SelectedItem="{Binding SelectedPrayer, Mode=TwoWay}"
                    SelectionChangedCommand="{Binding PrayerSelectedCommand}"
                    SelectionMode="Single"
                    VerticalOptions="Fill"
                    VerticalScrollBarVisibility="Never">
                    <CollectionView.ItemsLayout>
                        <!-- 🎨 PHASE 16: ItemSpacing=0 - Let DataTriggers control ALL spacing -->
                        <LinearItemsLayout ItemSpacing="0" Orientation="Vertical" />
                    </CollectionView.ItemsLayout>
                    <CollectionView.Header>
                        <StackLayout x:DataType="viewModels:MainViewModel">
                            <!-- Remaining Time Card -->
                            <Border Style="{StaticResource GlassCard}" Margin="12,8">
                                <Grid ColumnDefinitions="Auto,*" ColumnSpacing="12" Padding="12,10">
                                    <Border Grid.Column="0"
                                            WidthRequest="48"
                                            HeightRequest="48"
                                            Background="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}"
                                            StrokeShape="RoundRectangle 24"
                                            VerticalOptions="Center">
                                        <Label FontFamily="{StaticResource IconFontFamily}"
                                               FontSize="24"
                                               Text="&#xf017;"
                                               TextColor="{AppThemeBinding Light={StaticResource OnPrimary}, Dark={StaticResource OnPrimaryDark}}"
                                               VerticalOptions="Center"
                                               HorizontalTextAlignment="Center" />
                                    </Border>
                                    
                                    <Label Grid.Column="1"
                                           FontSize="{DynamicResource SubHeaderFontSize}"
                                           FontAttributes="Bold"
                                           Text="{Binding RemainingTime}"
                                           TextColor="{AppThemeBinding Light={StaticResource OnSurfaceLight}, Dark={StaticResource OnSurfaceDark}}"
                                           VerticalOptions="Center" />
                                </Grid>
                            </Border>
                        </StackLayout>
                    </CollectionView.Header>

                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="models:Prayer">
                            <Border Style="{StaticResource PrayerCardOptimized}">
                                <Border.Triggers>
                                    <DataTrigger TargetType="Border" Binding="{Binding IsActive}" Value="True">
                                        <Setter Property="BackgroundColor" Value="{AppThemeBinding Light={StaticResource PrimaryContainerLight}, Dark={StaticResource PrimaryContainerDark}}" />
                                        <Setter Property="Stroke" Value="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}" />
                                        <Setter Property="StrokeThickness" Value="2" />
                                    </DataTrigger>
                                    <DataTrigger TargetType="Border" Binding="{Binding IsPast}" Value="True">
                                        <Setter Property="Opacity" Value="0.6" />
                                    </DataTrigger>
                                </Border.Triggers>
                                <Grid ColumnDefinitions="Auto, *, Auto, Auto" ColumnSpacing="12">
                                    <Image Grid.Column="0" Source="{Binding IconPath}" WidthRequest="32" HeightRequest="32" VerticalOptions="Center" />
                                    <Label Grid.Column="1" Text="{Binding Name}" Style="{StaticResource BodyLargeStyle}" VerticalOptions="Center" />
                                    <Label Grid.Column="2" Text="{Binding Time}" Style="{StaticResource BodyLargeStyle}" FontAttributes="Bold" VerticalOptions="Center" />
                                    <ImageButton Grid.Column="3" Style="{StaticResource IconButton}" Command="{Binding NavigateCommand}">
                                        <ImageButton.Source>
                                            <FontImageSource FontFamily="IconFont"
                                                             Glyph="{Binding Enabled, Converter={StaticResource BoolToBellIconConverter}}"
                                                             Color="{Binding Enabled, Converter={StaticResource BoolToBellColorConverter}}" />
                                        </ImageButton.Source>
                                    </ImageButton>
                                </Grid>
                            </Border>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>

                    <CollectionView.Footer>
                        <StackLayout x:DataType="viewModels:MainViewModel" Orientation="Vertical" Spacing="8" Padding="16,8">
                            <!-- Monthly Calendar Button -->
                            <Button
                                Style="{StaticResource TonalButton}"
                                Text="{localization:Translate AylikTakvim}"
                                Command="{Binding GoToMonthCommand}"
                                IsEnabled="{Binding IsNotBusy}">
                                <Button.ImageSource>
                                    <FontImageSource
                                        FontFamily="{StaticResource IconFontFamily}"
                                        Glyph="&#xf073;"
                                        Color="{AppThemeBinding Light={StaticResource OnSecondaryContainer}, Dark={StaticResource OnSecondaryContainerDark}}" />
                                </Button.ImageSource>
                            </Button>

                            <!-- City Location Badge -->
                            <Border Style="{StaticResource MinimalLocationBadge}">
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding GoToMapCommand}" NumberOfTapsRequired="1" />
                                </Border.GestureRecognizers>
                                <Label
                                    Padding="12,6"
                                    HorizontalOptions="Center"
                                    VerticalTextAlignment="Center">
                                    <Label.FormattedText>
                                        <FormattedString>
                                            <Span
                                                FontFamily="{StaticResource IconFontFamily}"
                                                Text="&#xf3c5; " 
                                                TextColor="{AppThemeBinding Light={StaticResource OnSurfaceVariant}, Dark={StaticResource OnSurfaceVariantDark}}"/>
                                            <Span Text="{Binding City}" 
                                                  TextColor="{AppThemeBinding Light={StaticResource OnSurface}, Dark={StaticResource OnSurfaceDark}}"
                                                  FontAttributes="Bold"
                                                  TextTransform="Uppercase" />
                                        </FormattedString>
                                    </Label.FormattedText>
                                </Label>
                            </Border>
                        </StackLayout>
                    </CollectionView.Footer>
                </CollectionView>

                <!-- Long running overlay -->
                <Grid IsVisible="{Binding ShowOverlay}" BackgroundColor="{AppThemeBinding Light=#80FFFFFF, Dark=#80000000}">
                    <Border Style="{StaticResource Card}" Padding="32,20" HorizontalOptions="Center" VerticalOptions="Center">
                        <VerticalStackLayout Spacing="12" HorizontalOptions="Center">
                            <ActivityIndicator IsRunning="True" Color="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}" />
                            <Label Text="{Binding OverlayMessage}" Style="{StaticResource BodyLargeStyle}" HorizontalTextAlignment="Center" />
                        </VerticalStackLayout>
                    </Border>
                </Grid>
            </Grid>
        </RefreshView>
    </ContentPage.Content>
</ContentPage>
