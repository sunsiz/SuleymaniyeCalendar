<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="SuleymaniyeCalendar.Views.MainPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:localization="clr-namespace:LocalizationResourceManager.Maui;assembly=LocalizationResourceManager.Maui"
    xmlns:models="clr-namespace:SuleymaniyeCalendar.Models"
    xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
    xmlns:viewModels="clr-namespace:SuleymaniyeCalendar.ViewModels"
    x:Name="MainPageRoot"
    Title="{Binding Title}"
    x:DataType="viewModels:MainViewModel"
    FlowDirection="{DynamicResource FlowDirection}"
    BackgroundColor="{AppThemeBinding Light={StaticResource AppBackgroundColor}, Dark={StaticResource AppBackgroundColorDark}}">

    <Shell.TitleView>
        <Grid Margin="10" x:DataType="viewModels:MainViewModel" HeightRequest="40"
              ColumnDefinitions="*,Auto,Auto" ColumnSpacing="8">
            <Label Grid.Column="0"
                   AutomationProperties.IsInAccessibleTree="True"
                   FontAttributes="Bold"
                   FontSize="{DynamicResource HeaderFontSize}"
                   SemanticProperties.Description="{localization:Translate Takvim}"
                   SemanticProperties.HeadingLevel="Level1"
                   Style="{StaticResource LabelSectionHeader}"
                   Text="{localization:Translate PageTitle}"
                   VerticalTextAlignment="Start" />
            <Image Grid.Column="1"
                   x:DataType="viewModels:MainViewModel"
                   Margin="10,0,12,0"
                   AutomationProperties.IsInAccessibleTree="True"
                   VerticalOptions="Center"
                   SemanticProperties.Description="{localization:Translate UygulamaAyarlari}">
                <Image.Source>
                    <FontImageSource
                        FontAutoScalingEnabled="True"
                        FontFamily="{StaticResource IconFontFamily}"
                        Glyph="&#xf013;"
                        Size="{DynamicResource IconLargeFontSize}" />
                </Image.Source>
                <Image.GestureRecognizers>
                    <TapGestureRecognizer x:DataType="viewModels:MainViewModel" Command="{Binding SettingsCommand}" NumberOfTapsRequired="1" />
                </Image.GestureRecognizers>
            </Image>
            <Image Grid.Column="2"
                   x:DataType="viewModels:MainViewModel"
                   Margin="10,0,20,0"
                   AutomationProperties.IsInAccessibleTree="True"
                   VerticalOptions="Center"
                   SemanticProperties.Description="{localization:Translate Yenile}">
                <Image.Source>
                    <FontImageSource
                        FontFamily="{StaticResource IconFontFamily}"
                        Glyph="&#xf2f1;"
                        Size="{DynamicResource IconLargeFontSize}" />
                </Image.Source>
                <Image.GestureRecognizers>
                    <TapGestureRecognizer x:DataType="viewModels:MainViewModel" Command="{Binding RefreshLocationCommand}" NumberOfTapsRequired="1" />
                </Image.GestureRecognizers>
            </Image>
        </Grid>
    </Shell.TitleView>

    <ContentPage.Content>
        <RefreshView Command="{Binding RefreshLocationCommand}" IsRefreshing="{Binding IsRefreshing}">
            <Grid
                Padding="6,0"
                ColumnDefinitions="*"
                HorizontalOptions="Fill"
                RowDefinitions="*">
                <CollectionView
                    x:Name="PrayersView"
                    HorizontalOptions="Fill"
                    ItemsSource="{Binding Prayers}"
                    SelectedItem="{Binding SelectedPrayer, Mode=TwoWay}"
                    SelectionChangedCommand="{Binding PrayerSelectedCommand}"
                    SelectionMode="Single"
                    VerticalOptions="Fill"
                    VerticalScrollBarVisibility="Never">
                    <CollectionView.ItemsLayout>
                        <LinearItemsLayout ItemSpacing="0" Orientation="Vertical" />
                    </CollectionView.ItemsLayout>
                    <CollectionView.Header>
                        <StackLayout x:DataType="viewModels:MainViewModel">
                            <Border
                                Margin="3,7"
                                HorizontalOptions="Center"
                                IsEnabled="{Binding IsNotBusy}"
                                Style="{StaticResource LocationCard}">
                                <Label
                                    Margin="5,0"
                                    Padding="9,3"
                                    x:DataType="viewModels:MainViewModel"
                                    AutomationProperties.IsInAccessibleTree="True"
                                    HorizontalOptions="Center"
                                    SemanticProperties.Description="{localization:Translate Sehir}"
                                    Style="{StaticResource LocationStyle}"
                                    VerticalTextAlignment="Center">
                                    <Label.FormattedText>
                                        <FormattedString>
                                            <Span
                                                FontFamily="{StaticResource IconFontFamily}"
                                                FontSize="{DynamicResource SubHeaderFontSize}"
                                                Text="&#xf3c5; " />
                                            <Span Text="{Binding City}" TextTransform="Uppercase" />
                                        </FormattedString>
                                    </Label.FormattedText>
                                </Label>
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding GoToMapCommand}" NumberOfTapsRequired="1" />
                                </Border.GestureRecognizers>
                            </Border>
                        </StackLayout>
                    </CollectionView.Header>

                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="models:Prayer">
                            <ContentView Padding="0">
                                <!-- Enhanced Prayer Card with Premium Styling -->
                                <Border
                                    Margin="6,4"
                                    Style="{StaticResource PrayerCard}">
                                    <Border.Triggers>
                                        <DataTrigger
                                            Binding="{Binding IsPast}"
                                            TargetType="Border"
                                            Value="True">
                                            <Setter Property="BackgroundColor" Value="{AppThemeBinding Light={StaticResource PrayerPastBackgroundColor}, Dark={StaticResource PrayerPastBackgroundColorDark}}" />
                                            <Setter Property="Opacity" Value="0.6" />
                                        </DataTrigger>
                                        <DataTrigger
                                            Binding="{Binding IsActive}"
                                            TargetType="Border"
                                            Value="True">
                                            <Setter Property="BackgroundColor" Value="{AppThemeBinding Light={StaticResource PrayerActiveBackgroundColor}, Dark={StaticResource PrayerActiveBackgroundColorDark}}" />
                                            <Setter Property="Scale" Value="1.02" />
                                            <Setter Property="Shadow">
                                                <Shadow
                                                    Brush="{AppThemeBinding Light={StaticResource Success50}, Dark={StaticResource Success30}}"
                                                    Opacity="0.4"
                                                    Radius="32"
                                                    Offset="0,8" />
                                            </Setter>
                                        </DataTrigger>
                                        <MultiTrigger TargetType="Border">
                                            <MultiTrigger.Conditions>
                                                <BindingCondition Binding="{Binding IsActive}" Value="False" />
                                                <BindingCondition Binding="{Binding IsPast}" Value="False" />
                                            </MultiTrigger.Conditions>
                                            <Setter Property="BackgroundColor" Value="{AppThemeBinding Light={StaticResource PrayerUpcomingBackgroundColor}, Dark={StaticResource PrayerUpcomingBackgroundColorDark}}" />
                                        </MultiTrigger>
                                    </Border.Triggers>

                                    <Grid
                                        ColumnDefinitions="Auto,*,Auto,Auto"
                                        ColumnSpacing="12"
                                        RowDefinitions="Auto,Auto"
                                        RowSpacing="2">

                                        <!-- Animated Prayer Icon -->
                                        <Border
                                            Grid.Row="0"
                                            Grid.RowSpan="2"
                                            Grid.Column="0"
                                            WidthRequest="40"
                                            HeightRequest="40"
                                            BackgroundColor="Transparent"
                                            VerticalOptions="Center">
                                            <Image
                                                Source="{Binding IconPath}"
                                                Aspect="AspectFit"
                                                WidthRequest="32"
                                                HeightRequest="32"
                                                VerticalOptions="Center"
                                                HorizontalOptions="Center">
                                                <Image.Triggers>
                                                    <!-- Past prayers: Better visibility in light mode, more subtle in dark mode -->
                                                    <DataTrigger
                                                        Binding="{Binding IsPast}"
                                                        TargetType="Image"
                                                        Value="True">
                                                        <Setter Property="Opacity" Value="{AppThemeBinding Light=0.65, Dark=0.6}" />
                                                    </DataTrigger>
                                                    <!-- Current prayer: Full visibility with enhanced scaling -->
                                                    <DataTrigger
                                                        Binding="{Binding IsActive}"
                                                        TargetType="Image"
                                                        Value="True">
                                                        <Setter Property="Opacity" Value="1.0" />
                                                        <Setter Property="Scale" Value="1.1" />
                                                    </DataTrigger>
                                                    <!-- Upcoming prayers: High visibility in both modes -->
                                                    <MultiTrigger TargetType="Image">
                                                        <MultiTrigger.Conditions>
                                                            <BindingCondition Binding="{Binding IsActive}" Value="False" />
                                                            <BindingCondition Binding="{Binding IsPast}" Value="False" />
                                                        </MultiTrigger.Conditions>
                                                        <Setter Property="Opacity" Value="{AppThemeBinding Light=0.95, Dark=0.85}" />
                                                    </MultiTrigger>
                                                </Image.Triggers>
                                            </Image>
                                        </Border>

                                        <!-- Prayer Name with State-Based Colors -->
                                        <Label
                                            Grid.Row="0"
                                            Grid.Column="1"
                                            Style="{StaticResource PrayerNameStyle}"
                                            Text="{Binding Name}"
                                            VerticalOptions="End">
                                            <Label.Triggers>
                                                <DataTrigger
                                                    Binding="{Binding IsPast}"
                                                    TargetType="Label"
                                                    Value="True">
                                                    <Setter Property="TextColor" Value="{AppThemeBinding Light={StaticResource PrayerPastTextColor}, Dark={StaticResource PrayerPastTextColorDark}}" />
                                                </DataTrigger>
                                                <DataTrigger
                                                    Binding="{Binding IsActive}"
                                                    TargetType="Label"
                                                    Value="True">
                                                    <Setter Property="TextColor" Value="{AppThemeBinding Light={StaticResource PrayerActiveTextColor}, Dark={StaticResource PrayerActiveTextColorDark}}" />
                                                    <Setter Property="FontAttributes" Value="Bold" />
                                                </DataTrigger>
                                                <MultiTrigger TargetType="Label">
                                                    <MultiTrigger.Conditions>
                                                        <BindingCondition Binding="{Binding IsActive}" Value="False" />
                                                        <BindingCondition Binding="{Binding IsPast}" Value="False" />
                                                    </MultiTrigger.Conditions>
                                                    <Setter Property="TextColor" Value="{AppThemeBinding Light={StaticResource PrayerUpcomingTextColor}, Dark={StaticResource PrayerUpcomingTextColorDark}}" />
                                                </MultiTrigger>
                                            </Label.Triggers>
                                        </Label>

                                        <!-- Prayer Description with Astronomical Information - Hidden for now (not translated) -->
                                        <!--
                                        <Label
                                            Grid.Row="1"
                                            Grid.Column="1"
                                            Style="{StaticResource CaptionStyle}"
                                            Text="{Binding Description}"
                                            LineBreakMode="TailTruncation"
                                            MaxLines="1"
                                            VerticalOptions="Start"
                                            Margin="0,2,0,0">
                                            <Label.Triggers>
                                                <DataTrigger
                                                    Binding="{Binding IsPast}"
                                                    TargetType="Label"
                                                    Value="True">
                                                    <Setter Property="TextColor" Value="{AppThemeBinding Light={StaticResource PrayerPastTextColor}, Dark={StaticResource PrayerPastTextColorDark}}" />
                                                    <Setter Property="Opacity" Value="0.7" />
                                                </DataTrigger>
                                                <DataTrigger
                                                    Binding="{Binding IsActive}"
                                                    TargetType="Label"
                                                    Value="True">
                                                    <Setter Property="TextColor" Value="{AppThemeBinding Light={StaticResource PrayerActiveTextColor}, Dark={StaticResource PrayerActiveTextColorDark}}" />
                                                    <Setter Property="Opacity" Value="0.9" />
                                                </DataTrigger>
                                                <MultiTrigger TargetType="Label">
                                                    <MultiTrigger.Conditions>
                                                        <BindingCondition Binding="{Binding IsActive}" Value="False" />
                                                        <BindingCondition Binding="{Binding IsPast}" Value="False" />
                                                    </MultiTrigger.Conditions>
                                                    <Setter Property="TextColor" Value="{AppThemeBinding Light={StaticResource PrayerUpcomingTextColor}, Dark={StaticResource PrayerUpcomingTextColorDark}}" />
                                                    <Setter Property="Opacity" Value="0.8" />
                                                </MultiTrigger>
                                            </Label.Triggers>
                                        </Label>
                                        -->

                                        <!-- Prayer Time with State-Based Colors -->
                                        <Label
                                            Grid.Row="0"
                                            Grid.Column="2"
                                            HorizontalTextAlignment="End"
                                            Style="{StaticResource PrayerTimeStyle}"
                                            Text="{Binding Time}"
                                            VerticalOptions="End">
                                            <Label.Triggers>
                                                <DataTrigger
                                                    Binding="{Binding IsPast}"
                                                    TargetType="Label"
                                                    Value="True">
                                                    <Setter Property="TextColor" Value="{AppThemeBinding Light={StaticResource PrayerPastTextColor}, Dark={StaticResource PrayerPastTextColorDark}}" />
                                                </DataTrigger>
                                                <DataTrigger
                                                    Binding="{Binding IsActive}"
                                                    TargetType="Label"
                                                    Value="True">
                                                    <Setter Property="TextColor" Value="{AppThemeBinding Light={StaticResource PrayerActiveTextColor}, Dark={StaticResource PrayerActiveTextColorDark}}" />
                                                    <Setter Property="FontAttributes" Value="Bold" />
                                                </DataTrigger>
                                                <MultiTrigger TargetType="Label">
                                                    <MultiTrigger.Conditions>
                                                        <BindingCondition Binding="{Binding IsActive}" Value="False" />
                                                        <BindingCondition Binding="{Binding IsPast}" Value="False" />
                                                    </MultiTrigger.Conditions>
                                                    <Setter Property="TextColor" Value="{AppThemeBinding Light={StaticResource PrayerUpcomingTextColor}, Dark={StaticResource PrayerUpcomingTextColorDark}}" />
                                                </MultiTrigger>
                                            </Label.Triggers>
                                        </Label>

                                        <!-- Enhanced Notification Bell with Better Visual Distinction -->
                                        <Border
                                            Grid.Row="0"
                                            Grid.RowSpan="2"
                                            Grid.Column="3"
                                            BackgroundColor="Transparent"
                                            Background="{AppThemeBinding Light={StaticResource SurfaceGlassBrushLight}, Dark={StaticResource SurfaceGlassBrushDark}}"
        									Stroke="{StaticResource GlassStrokeBrush}"
                                            StrokeThickness="0.75"
                                            StrokeShape="RoundRectangle 16"
                                            WidthRequest="36"
                                            HeightRequest="36"
                                            VerticalOptions="Center">
                                            <Label
                                                AutomationProperties.IsInAccessibleTree="True"
                                                FontFamily="FontAwesomeSolid"
                                                FontSize="{DynamicResource IconMediumFontSize}"
                                                HorizontalOptions="Center"
                                                VerticalOptions="Center"
                                                Text="&#xe7f6;"
                                                TextColor="{AppThemeBinding Light={StaticResource HighContrastOnSurface}, Dark={StaticResource HighContrastOnSurfaceDark}}">
                                                <Label.Triggers>
                                                    <DataTrigger
                                                        Binding="{Binding Enabled}"
                                                        TargetType="Label"
                                                        Value="False">
                                                        <Setter Property="Text" Value="&#xf1f6;" />
                                                        <Setter Property="SemanticProperties.Description" Value="{localization:Translate DevreDisi}" />
                                                        <Setter Property="TextColor" Value="{AppThemeBinding Light={StaticResource HighContrastOutline}, Dark={StaticResource HighContrastOutlineDark}}" />
                                                        <Setter Property="Opacity" Value="0.6" />
                                                    </DataTrigger>
                                                    <DataTrigger
                                                        Binding="{Binding Enabled}"
                                                        TargetType="Label"
                                                        Value="True">
                                                        <Setter Property="Text" Value="&#xf0f3;" />
                                                        <Setter Property="SemanticProperties.Description" Value="{localization:Translate Etkin}" />
                                                        <Setter Property="TextColor" Value="{AppThemeBinding Light={StaticResource Success60}, Dark={StaticResource Success30}}" />
                                                        <Setter Property="Opacity" Value="1.0" />
                                                    </DataTrigger>
                                                </Label.Triggers>
                                            </Label>
                                            <Border.GestureRecognizers>
                                                <TapGestureRecognizer x:DataType="{x:Null}"
                                                    Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.PrayerSelectedCommand}"
                                                    CommandParameter="{Binding .}" />
                                            </Border.GestureRecognizers>
                                            <Border.Triggers>
                                                <DataTrigger
                                                    Binding="{Binding Enabled}"
                                                    TargetType="Border"
                                                    Value="True">
                                                    <Setter Property="BackgroundColor" Value="{AppThemeBinding Light={StaticResource Success10}, Dark={StaticResource Success95}}" />
                                                    <Setter Property="Stroke" Value="{AppThemeBinding Light={StaticResource Success40}, Dark={StaticResource Success60}}" />
                                                    <Setter Property="StrokeThickness" Value="1.25" />
                                                </DataTrigger>
                                                <DataTrigger
                                                    Binding="{Binding Enabled}"
                                                    TargetType="Border"
                                                    Value="False">
                                                    <Setter Property="Stroke" Value="{StaticResource GlassStrokeBrush}" />
                                                    <Setter Property="StrokeThickness" Value="0.75" />
                                                </DataTrigger>
                                            </Border.Triggers>
                                        </Border>
                                    </Grid>
                                </Border>
                            </ContentView>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>

                    <CollectionView.Footer>
                        <StackLayout x:DataType="viewModels:MainViewModel" Orientation="Vertical" Spacing="12" Margin="0,16">
                            <!-- Monthly Calendar Button with gradient background (rounded) -->
                            <Border 
                                Padding="0"
                                Margin="16,0"
                                HorizontalOptions="Center"
                                StrokeThickness="0"
                                Background="{StaticResource PrimaryGradientBrush}">
                                <Border.StrokeShape>
                                    <RoundRectangle CornerRadius="25" />
                                </Border.StrokeShape>
                                <Button
                                    Text="{localization:Translate AylikTakvim}"
                                    Command="{Binding GoToMonthCommand}"
                                    BackgroundColor="Transparent"
                                    TextColor="{AppThemeBinding Light={StaticResource OnPrimaryColor}, Dark={StaticResource OnPrimaryColor}}"
                                    FontFamily="OpenSansRegular"
                                    FontSize="{DynamicResource BodyFontSize}"
                                    FontAttributes="Bold"
                                    Padding="24,16"
                                    MinimumHeightRequest="56"
                                    HorizontalOptions="Center"
                                    IsEnabled="{Binding IsNotBusy}">
                                    <Button.ImageSource>
                                        <FontImageSource
                                            FontFamily="{StaticResource IconFontFamily}"
                                            Glyph="&#xf073;"
                                            Size="{DynamicResource IconMediumSize}"
                                            Color="{AppThemeBinding Light={StaticResource OnPrimaryColor}, Dark={StaticResource OnPrimaryColor}}" />
                                    </Button.ImageSource>
                                </Button>
                            </Border>

                            <!-- Remaining Time Card with glass effect -->
                            <Border
                                Margin="16,0,16,16"
                                Style="{StaticResource GlassCard}"
                                HorizontalOptions="Fill">
                                <Grid ColumnDefinitions="Auto,*" ColumnSpacing="12">
                                    <Border
                                        Grid.Column="0"
                                        BackgroundColor="{AppThemeBinding Light={StaticResource Secondary10}, Dark={StaticResource Secondary95}}"
                                        StrokeShape="RoundRectangle 16"
                                        WidthRequest="32"
                                        HeightRequest="32"
                                        VerticalOptions="Center">
                                        <Label
                                            FontFamily="{StaticResource IconFontFamily}"
                                            FontSize="{DynamicResource IconMediumFontSize}"
                                            HorizontalOptions="Center"
                                            VerticalOptions="Center"
                                            Text="&#xf017;"
                                            TextColor="{AppThemeBinding Light={StaticResource SecondaryColor}, Dark={StaticResource Secondary30}}" />
                                    </Border>
                                    
                                    <Label
                                        Grid.Column="1"
                                        AutomationProperties.IsInAccessibleTree="True"
                                        Style="{StaticResource BodyLargeStyle}"
                                        Text="{Binding RemainingTime}"
                                        VerticalOptions="Center" />
                                </Grid>
                            </Border>
                        </StackLayout>
                    </CollectionView.Footer>
                </CollectionView>
            </Grid>
        </RefreshView>
    </ContentPage.Content>
</ContentPage>
